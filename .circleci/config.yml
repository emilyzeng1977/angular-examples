version: 2.1
jobs:
   DeployDevelop:
     docker:
       - image: circleci/python:3

     environment:
       GH_TOKEN: 17e396315d1e9961cbaa46afd2f100257990555
       SSL_PASSPHRASE: nyz931644
       REPO_ENC_KEY: 7CED24AF8D9A1B136E031B84E3CD107CE13DB161B9F3BDAD69EC00B4D23B3CE0
       REPO_ENC_IV: 1C3FEA072C745F8BD53629F4B7CAB091
     steps:
       - checkout
       - run: echo "start prepare envirement..."
       - run:
           name: prepareEnv
           command: |
             echo $GITHUB_TOKEN
             export GITHUB_TOKEN=${GITHUB_TOKEN}"7"
             openssl aes-256-cbc -d -K $REPO_ENC_KEY -iv $REPO_ENC_IV -in git_deploy_key.enc -out /tmp/git_deploy_key
             chmod 600 /tmp/git_deploy_key
             echo 'echo ${SSL_PASSPHRASE}' > /tmp/askpass && chmod +x /tmp/askpass
             eval "$(ssh-agent -s)"
             openssl aes-256-cbc -d -K $REPO_ENC_KEY -iv $REPO_ENC_IV -in git_deploy_key.enc -out /tmp/git_deploy_key
             sudo apt update
             curl -sL https://deb.nodesource.com/setup_12.x | sudo -E bash -
             sudo apt install nodejs
             node --version
             npm --version
             cd bookStore
             npx semantic-release
             appVersion=$(cat ./package.json | jq -r '.version')
             echo ${appVersion}


   approval:
     docker:
       - image: circleci/python:3
     steps:
       - run: echo "You wanna destroy it?"
   destroy:
     docker:
       - image: circleci/python:3
     steps:
       - checkout
       - attach_workspace:
           at: /tmp/workspace
       - run: cat /tmp/workspace/artifects/output.status
       - run:
           name: destroy
           command: |
             sudo apt update
             sudo apt install -y python3-pip jq
             sudo pip3 install awscli
             echo ${AWS_ACCESS_KEY_ID}
             echo ${AWS_SECRET_ACCESS_KEY}

             bash ./manage_vpc.sh destroy

workflows:
   DeployDevelop123:
     jobs:
       - DeployDevelop:
           name: DeployDevelop

